<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>CLOCK ONAIR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --font-main: -apple-system, BlinkMacSystemFont, system-ui, "Segoe UI", sans-serif;

      /* DARK THEME */
      --bg-main-dark: radial-gradient(circle at top, #404e83 0, #102467 55%, #020308 100%);
      --bg-onair-dark: radial-gradient(circle at center, #ff5757 0, #990000 45%, #2b0000 100%);
      --bg-top-dark: radial-gradient(circle at center, #36ff9b 0, #00914d 45%, #013320 100%);

      --text-primary-dark: #f5f5f7;
      --text-muted-dark: #9c9ca4;
      --accent-dark: #23d56b;
      --danger-dark: #ff3b30;
      --surface-dark: rgba(255,255,255,0.03);
      --border-subtle-dark: rgba(255,255,255,0.08);

      /* LIGHT THEME */
      --bg-main-light: radial-gradient(circle at top, #f7f8ff 0, #ffffff 50%, #f0f2f7 100%);
      --bg-onair-light: radial-gradient(circle at center, #ffdede 0, #ff9a9a 45%, #ffe4e4 100%);
      --bg-top-light: radial-gradient(circle at center, #d9ffec 0, #93fcca 45%, #e9fff5 100%);

      --text-primary-light: #0f172a;
      --text-muted-light: #4a5568;
      --accent-light: #00b86b;
      --danger-light: #cc0000;
      --surface-light: rgba(255,255,255,0.65);
      --border-subtle-light: rgba(0,0,0,0.15);

      --np-green: #23d56b;
      --np-orange: #ff9f0a;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-main);
      display: flex;
      justify-content: center;
      align-items: stretch;
      background: #000;
      background-image: var(--bg-main-dark);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: #fff;
      transition: background 180ms ease-out, background-image 180ms ease-out, color 180ms ease-out;
    }

    body.theme-dark {
      --bg-main: var(--bg-main-dark);
      --bg-onair: var(--bg-onair-dark);
      --bg-top: var(--bg-top-dark);
      --text-primary: var(--text-primary-dark);
      --text-muted: var(--text-muted-dark);
      --accent: var(--accent-dark);
      --danger: var(--danger-dark);
      --surface: var(--surface-dark);
      --border-subtle: var(--border-subtle-dark);
      background-image: var(--bg-main-dark);
      color: var(--text-primary-dark);
    }

    body.theme-light {
      --bg-main: var(--bg-main-light);
      --bg-onair: var(--bg-onair-light);
      --bg-top: var(--bg-top-light);
      --text-primary: var(--text-primary-light);
      --text-muted: var(--text-muted-light);
      --accent: var(--accent-light);
      --danger: var(--danger-light);
      --surface: var(--surface-light);
      --border-subtle: var(--border-subtle-light);
      background-image: var(--bg-main-light);
      color: var(--text-primary-light);
    }

    body.status-default { background-image: var(--bg-main); }
    body.status-onair   { background-image: var(--bg-onair); }
    body.status-top     { background-image: var(--bg-top); }

    .screen {
      position: relative;
      flex: 1;
      max-width: 1400px;
      padding: 16px 24px 24px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      color: var(--text-primary);
      backdrop-filter: blur(8px);
      background: radial-gradient(circle at top, rgba(0,0,0,0.45), rgba(0,0,0,0.75));
      border-radius: 20px;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.05),
        0 18px 50px rgba(0,0,0,0.9);
      transition: box-shadow 180ms ease-out, border-color 180ms ease-out, background 180ms ease-out;
    }

    body.status-onair .screen {
      box-shadow:
        0 0 0 1px rgba(255,120,120,0.35),
        0 0 45px rgba(255,80,80,0.7),
        0 30px 80px rgba(0,0,0,0.95);
    }

    body.status-top .screen {
      box-shadow:
        0 0 0 1px rgba(80,255,170,0.35),
        0 0 45px rgba(60,255,170,0.7),
        0 30px 80px rgba(0,0,0,0.95);
    }

    body.theme-light .screen {
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.1), rgba(235, 241, 255, 0));
      box-shadow:
        0 0 0 1px rgba(0,0,0,0.06),
        0 22px 38px rgba(0,0,0,0.18);
    }

    /* HEADER */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.14);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .header-center {
      flex: 1;
      min-width: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .header-center-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .header-onair-chrono {
      font-size: 1.6rem;
      font-variant-numeric: tabular-nums;
      color: var(--danger);
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: flex-end;
    }

    /* LOGO */
    .logo-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .logo-svg {
      height: 34px;
      width: auto;
      display: block;
    }

    .logo-svg .logo-s0 { fill: #000000; }
    .logo-svg .logo-s1 { fill: #0064f5; }
    .logo-svg .logo-s2 { fill: #001ed2; }

    .logo-svg .logo-text-shape { fill: #000000; }
    body.theme-dark .logo-svg .logo-text-shape { fill: #ffffff; }
    body.theme-light .logo-svg .logo-text-shape { fill: #000000; }

    body.status-default .logo-svg .logo-s1 { fill: #0064f5; }
    body.status-default .logo-svg .logo-s2 { fill: #001ed2; }
    body.status-onair .logo-svg .logo-s1 { fill: #ff5757; }
    body.status-onair .logo-svg .logo-s2 { fill: #b00000; }
    body.status-top .logo-svg .logo-s1 { fill: #36ff9b; }
    body.status-top .logo-svg .logo-s2 { fill: #019454; }

    .logo-svg .logo-pulse {
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      opacity: 0;
      transform-origin: 64px 65px;
      animation: logo-pulse 2.4s ease-out infinite;
    }

    body.status-default .logo-svg .logo-pulse { stroke: #0064f5; }
    body.status-onair  .logo-svg .logo-pulse { stroke: #ff5757; }
    body.status-top    .logo-svg .logo-pulse { stroke: #36ff9b; }

    .logo-svg .logo-disc-group {
      transform-origin: 64px 65px;
      animation: logo-breathe 2.8s ease-in-out infinite;
    }

    @keyframes logo-breathe {
      0%   { transform: scale(1);    filter: drop-shadow(0 0 0 rgba(0,0,0,0)); }
      50%  { transform: scale(1.04); filter: drop-shadow(0 0 8px rgba(255,255,255,0.35)); }
      100% { transform: scale(1);    filter: drop-shadow(0 0 0 rgba(0,0,0,0)); }
    }

    @keyframes logo-pulse {
      0%   { transform: scale(0.7); opacity: 0.8; }
      60%  { transform: scale(1.4); opacity: 0.1; }
      100% { transform: scale(1.6); opacity: 0; }
    }

    /* USER SUMMARY + HOME */
    .user-summary {
      display: flex;
      flex-direction: column;
      font-size: 0.7rem;
      line-height: 1.2;
      color: var(--text-muted);
      text-align: right;
    }

    .btn-home {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: linear-gradient(
        to bottom,
        rgba(255,255,255,0.12),
        rgba(255,255,255,0.02)
      );
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      cursor: pointer;
      color: inherit;
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
    }

    body.theme-light .btn-home {
      background: linear-gradient(
        to bottom,
        rgba(255,255,255,1),
        rgba(234,240,255,1)
      );
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }

    .btn-home:active {
      transform: translateY(1px);
    }

    /* MESSAGE SOUS HEADER */
    .last-message-row {
      margin-top: 16px;
      margin-bottom: 4px;
      display: flex;
      justify-content: center;
    }

    .chat-last-inline-btn {
      font-size: 0.8rem;
      color: var(--text-muted);
      max-width: 100%;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(0,0,0,0.55);
      padding: 6px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    body.theme-light .chat-last-inline-btn {
      background: rgba(255,255,255,0.9);
      border-color: rgba(0,0,0,0.12);
    }

    .chat-last-inline-btn span:first-child {
      opacity: 0.8;
    }

    /* MAIN AREA */
    .main-area {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding-top: 6px;
      padding-bottom: 16px;
    }

    .central-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 18px;
      width: 100%;
      max-width: 520px;
    }

    /* CLOCK */
    .clock-container {
      width: 100%;
      display: flex;
      justify-content: center;
    }

    .clock {
      position: relative;
      width: min(64vh, 420px);
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .clock-svg-main {
      position: absolute;
      inset: 0;
    }

    .clock-background-circle {
      fill: rgba(0, 0, 0, 0.55);
      stroke: rgba(255, 255, 255, 0.12);
      stroke-width: 1;
    }

    body.theme-light .clock-background-circle {
      fill: rgb(255, 255, 255);
      stroke: rgba(0, 0, 0, 0.08);
    }

    .clock-dot {
      fill: rgba(255,255,255,0.35);
      filter: drop-shadow(0 0 3px rgba(0,0,0,0.7));
    }

    .clock-dot.active {
      fill: var(--accent);
      filter: drop-shadow(0 0 6px rgba(35,213,107,0.9));
    }

    .np-ring-base {
      fill: none;
      stroke: rgba(255, 255, 255, 0.16);
      stroke-width: 3;
    }

    .np-ring-progress {
      fill: none;
      stroke: var(--accent);
      stroke-width: 3;
      stroke-linecap: round;
      stroke-dasharray: 440;
      stroke-dashoffset: 440;
      filter: drop-shadow(0 0 6px rgba(35, 213, 107, 0.75));
      transition: stroke 120ms ease-out;
    }

    .clock-core {
      position: relative;
      z-index: 2;
      text-align: center;
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
      width: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .clock-time {
      font-size: clamp(2.5rem, 4vw, 3.4rem);
      letter-spacing: 0.04em;
      font-variant-numeric: tabular-nums;
      margin-bottom: 2px;
      color: var(--text-primary);
    }

    .onair-label {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--danger);
      margin-bottom: 2px;
    }

    .np-phase-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--np-orange);
      min-height: 1em;
    }

    .np-chrono-main {
      font-size: 2.4rem;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.04em;
      color: var(--text-primary);
    }

    .now-playing {
      margin-top: 10px;
      user-select: none;
    }

    .now-playing-artist {
      font-size: 1.35rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .now-playing-title {
      font-size: 1.15rem;
      text-transform: uppercase;
      letter-spacing: 0.10em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-top: 10px;
    }

    .btn {
      min-width: 120px;
      padding: 10px 24px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(0,0,0,0.6);
      color: var(--text-primary-dark);
      font-size: 0.95rem;
      font-weight: 500;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      cursor: pointer;
      outline: none;
      transition: transform 0.08s ease-out,
        box-shadow 0.12s ease-out,
        background 0.12s ease-out,
        border-color 0.12s ease-out,
        filter 0.12s ease-out;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }

    .btn-primary {
      background: linear-gradient(
        to bottom,
        rgba(255, 255, 255, 0.08),
        rgba(255, 255, 255, 0.02)
      );
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
    }

    .btn-active {
      filter: brightness(1.25);
      box-shadow: 0 0 18px rgba(255,255,255,0.4);
    }

    .btn:active {
      transform: translateY(1px) scale(0.99);
    }

    body.theme-light .btn {
      background: rgba(255,255,255,0.9);
      color: var(--text-primary-light);
      border-color: rgba(0,0,0,0.12);
      box-shadow: 0 8px 20px rgba(0,0,0,0.18);
    }

    body.theme-light .btn-primary {
      background: linear-gradient(
        to bottom,
        rgba(255,255,255,1),
        rgba(234,240,255,1)
      );
    }

    body.theme-light .btn-active {
      box-shadow: 0 0 22px rgba(0,184,107,0.45);
    }

    .chat-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,0.45);
      z-index: 50;
    }

    .chat-modal {
      position: relative;
      width: 420px;
      max-width: 90vw;
      max-height: 80vh;
      background: rgba(10,10,14,0.98);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      box-shadow: 0 24px 60px rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-modal-header {
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: radial-gradient(circle at top, rgba(255,255,255,0.08), rgba(0,0,0,0.3));
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .chat-modal-title {
      flex: 1;
    }

    .chat-close {
      border: none;
      background: transparent;
      color: inherit;
      cursor: pointer;
      font-size: 1.1rem;
      line-height: 1;
      padding: 0 4px;
    }

    .chat-modal-body {
      flex: 1;
      padding: 8px 10px;
      overflow-y: auto;
      font-size: 0.8rem;
    }

    .chat-message {
      margin-bottom: 6px;
      padding: 4px 6px;
      border-radius: 6px;
      background: rgba(255,255,255,0.04);
    }

    .chat-message-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 2px;
      font-weight: 600;
    }

    .chat-message-header time {
      font-weight: 400;
      opacity: 0.6;
      font-size: 0.75rem;
    }

    .chat-message-text {
      font-size: 0.8rem;
    }

    .chat-modal-input {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px 8px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.6);
      color: inherit;
      padding: 6px 10px;
      font-size: 0.8rem;
      outline: none;
    }

    .chat-send-btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(0,0,0,0.7);
      color: var(--text-primary-dark);
      padding: 6px 12px;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
    }

    body.theme-light .chat-modal {
      background: rgba(246,248,255,0.98);
      color: var(--text-primary-light);
      border-color: rgba(0,0,0,0.12);
    }

    body.theme-light .chat-modal-header {
      background: radial-gradient(circle at top, rgba(255,255,255,0.92), rgba(226,234,255,1));
      border-color: rgba(0,0,0,0.06);
    }

    body.theme-light .chat-message {
      background: rgba(255,255,255,0.9);
    }

    body.theme-light .chat-input {
      background: rgba(255,255,255,0.95);
      color: var(--text-primary-light);
      border-color: rgba(0,0,0,0.15);
    }

    body.theme-light .chat-send-btn {
      background: rgba(255,255,255,0.9);
      color: var(--text-primary-light);
      border-color: rgba(0,0,0,0.12);
    }

    @media (max-width: 768px) {
      .screen { padding: 12px 12px 18px; }
      .central-column { max-width: 100%; }
      .clock { width: min(68vh, 360px); }
      .controls { gap: 12px; }
    }

    @media (max-width: 480px) {
      .app-header { flex-wrap: wrap; row-gap: 6px; }
      .header-center { order: 3; width: 100%; }
      .header-right { max-width: 100%; }
      .clock { width: min(70vh, 310px); }
      .controls { width: 100%; justify-content: center; }
      .btn { flex: 1; min-width: 0; }
    }
  </style>
</head>
<body class="theme-dark status-default">
  <div class="screen">
    <!-- HEADER -->
    <header class="app-header">
      <div class="header-left">
        <div class="logo-wrapper">
          <svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 515 130" aria-hidden="true">
            <g id="ici">
              <path fill-rule="evenodd" class="logo-s0 logo-text-shape" d="m170.1 0.7v23.8h-26.2v-23.8zm22.5 115.2c-8.7-8.7-13-20.5-13-35.5 0-14.8 4.5-26.6 13.4-35.4 8.9-8.9 20.8-13.3 35.9-13.3 12.6 0 23 3.2 30.9 9.8 7.9 6.5 12.7 15.4 14.6 26.9h-27.1c-2.2-9.7-8.8-15.4-18.8-15.4-6.7 0-12.2 2.6-16.2 7.6-4 5.1-6.1 11.7-6.1 19.8 0 8.1 2.1 14.8 6.1 19.8q1.4 1.8 3.3 3.2 1.8 1.5 3.9 2.5 2.1 1 4.4 1.4 2.3 0.5 4.6 0.5c10.1 0 17-6 18.8-15.7h27.3c-1.9 11.4-6.9 20.4-15 27-8.3 6.6-18.8 9.9-31.6 9.9-15.1 0-26.9-4.3-35.4-13.1zm-48.7-83.1h26.2v95.1h-26.2zm139.2 0h26.2v95.1h-26.2v-95.1zm26.1-32.1v23.8h-26.2v-23.8z"/>
              <g class="logo-disc-group">
                <path class="logo-s1" d="m64 129.4c-35.4 0-64-28.7-64-64.3 0-35.5 28.6-64.2 64-64.2 35.4 0 64 28.7 64 64.2 0 35.6-28.6 64.3-64 64.3z"/>
                <path class="logo-s0" d="m64 65.1v64.3h-64v-64.3z"/>
                <path fill-rule="evenodd" class="logo-s2" d="m63.9 129.4h0.1v-64.3h-64c0 35.5 28.6 64.2 63.9 64.3z"/>
              </g>
              <circle class="logo-pulse" cx="64" cy="65" r="10" />
            </g>
          </svg>
        </div>
      </div>

      <div class="header-center">
        <div class="header-center-inner">
          <div class="header-onair-chrono" id="onair-chrono-header">00:00</div>
        </div>
      </div>

      <div class="header-right">
        <button class="btn-home" id="btn-home" type="button">
          RETOUR
        </button>
        <div class="user-summary">
          <div id="summary-user">Utilisateur : —</div>
          <div id="summary-role">Rôle : —</div>
          <div id="summary-studio">Studio : —</div>
        </div>
      </div>
    </header>

    <!-- BANDEAU DERNIER MESSAGE SOUS LE HEADER -->
    <div class="last-message-row">
      <button class="chat-last-inline-btn" id="chat-last-inline" type="button">
        <span>Dernier message :</span>
        <span id="chat-last-inline-text">Bonne émission !!</span>
      </button>
    </div>

    <!-- BLOC CENTRAL -->
    <main class="main-area">
      <div class="central-column">
        <div class="clock-container">
          <div class="clock">
            <svg class="clock-svg-main" viewBox="0 0 200 200" preserveAspectRatio="xMidYMid meet">
              <circle class="clock-background-circle" cx="100" cy="100" r="72" />
              <g id="dots-layer"></g>
              <circle class="np-ring-base" cx="100" cy="100" r="70"
                      transform="rotate(-90 100 100)" />
              <circle class="np-ring-progress" id="np-ring-progress" cx="100" cy="100" r="70"
                      transform="rotate(-90 100 100)" />
            </svg>

            <div class="clock-core">
              <div class="clock-time" id="clock-time">--:--:--</div>
              <div class="onair-label" id="onair-label"></div>
              <div class="np-phase-label" id="np-phase-label"></div>
              <div class="np-chrono-main" id="np-chrono-main">00:00</div>
            </div>
          </div>
        </div>

        <section class="now-playing">
          <div class="now-playing-artist" id="np-artist">NOM DE L’ARTISTE</div>
          <div class="now-playing-title" id="np-title">
            TITRE EN COURS DE DIFFUSION
          </div>
        </section>

        <div class="controls">
          <button class="btn btn-primary" id="btn-top" type="button">
            TOP
          </button>
          <button class="btn" id="btn-ordres" type="button">
            ORDRES
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- CHAT MODAL OVERLAY -->
  <div class="chat-overlay" id="chat-overlay">
    <div class="chat-modal" id="chat-modal">
      <div class="chat-modal-header" id="chat-modal-header">
        <div class="chat-modal-title" id="chat-modal-title">Chat studio</div>
        <button class="chat-close" id="chat-close" type="button">×</button>
      </div>
      <div class="chat-modal-body" id="chat-modal-body"></div>
      <div class="chat-modal-input">
        <input
          type="text"
          id="chat-input"
          class="chat-input"
          placeholder="Votre message…"
        />
        <button class="chat-send-btn" id="chat-send" type="button">
          Envoyer
        </button>
      </div>
    </div>
  </div>

  <audio id="top-sound" preload="auto">
    <source
      src="data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAEQAAAB8fHx3d3dwcHBvb29sbGxra2tmZmZkZGRjY2Nra2tsbGxvb29wcHB3d3d8fHx5eXl7e3t5eXl3d3dvb29tbW1tbW1vb29zc3N3d3d7e3t/f3////9/f39/f3t7e3l5eXd3d3FxcW1tbWxsbG1tbXFxcXd3d3l5eXt7e39/f3////9/f3+AgIA="
      type="audio/wav"
    />
  </audio>

  <script>
    (function () {
      function byId(id) { return document.getElementById(id); }
      function pad2(n) { n = Math.floor(n); return (n < 10 ? "0" : "") + n; }
      function formatMMSS(totalSeconds) {
        totalSeconds = Math.max(0, Math.floor(totalSeconds));
        var m = pad2(Math.floor(totalSeconds / 60));
        var s = pad2(totalSeconds % 60);
        return m + ":" + s;
      }
      function nowHHMM() {
        var d = new Date();
        return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
      }

      window.addEventListener("DOMContentLoaded", function () {
        var body = document.body;

        /* Thème depuis la home */
        try {
          var storedTheme = window.localStorage.getItem("clock_theme");
          if (storedTheme === "light") {
            body.classList.remove("theme-dark");
            body.classList.add("theme-light");
          } else {
            body.classList.remove("theme-light");
            body.classList.add("theme-dark");
          }
        } catch (e) {}
        body.classList.add("status-default");

        /* USER / RÔLE / STUDIO */
        var headerOnAirChrono = byId("onair-chrono-header");
        var btnHome = byId("btn-home");

        var summaryUser = byId("summary-user");
        var summaryRole = byId("summary-role");
        var summaryStudio = byId("summary-studio");

        var userName = "Moi";
        var userRole = null;
        var studio = "A";

        try {
          var storedName = window.localStorage.getItem("clock_user_name");
          if (storedName) userName = storedName;

          var storedRole = window.localStorage.getItem("clock_user_role");
          if (storedRole) userRole = storedRole;

          var storedStudio = window.localStorage.getItem("clock_user_studio");
          if (storedStudio) studio = storedStudio.toUpperCase();
        } catch (e) {}

        var search = window.location.search;
        if (search.length > 1) {
          var params = new URLSearchParams(search);
          if (params.has("studio")) studio = params.get("studio").toUpperCase();
        }

        if (summaryUser)  summaryUser.textContent  = "Utilisateur : " + userName;
        if (summaryRole)  summaryRole.textContent  = "Rôle : " + (userRole || "—");
        if (summaryStudio) summaryStudio.textContent = "Studio : " + studio;

        if (btnHome) {
          btnHome.addEventListener("click", function (e) {
            if (e && e.preventDefault) e.preventDefault();
            window.location.href = "index.html";
          });
        }

        /* HORLOGE + NP */
        var clockTimeEl = byId("clock-time");
        var onairLabelEl = byId("onair-label");
        var npPhaseLabelEl = byId("np-phase-label");
        var npChronoMainEl = byId("np-chrono-main");
        var npRingProgress = byId("np-ring-progress");
        var dotsLayer = byId("dots-layer");

        var npArtistEl = byId("np-artist");
        var npTitleEl = byId("np-title");

        function applyNowPlaying(np) {
          if (!np) return;
          if (npArtistEl) npArtistEl.textContent = np.artist || " ";
          if (npTitleEl)  npTitleEl.textContent  = np.title  || " ";
        }

        function fetchNowPlayingOnce() {
          fetch("/api/nowplaying")
            .then(r => r.json())
            .then(res => {
              if (res && res.ok && res.nowPlaying) applyNowPlaying(res.nowPlaying);
            })
            .catch(() => {});
        }

        fetchNowPlayingOnce();
        setInterval(fetchNowPlayingOnce, 10000);

        /* TOP + ON AIR */
        var topBtn = byId("btn-top");
        var ordresBtn = byId("btn-ordres");
        var topSound = byId("top-sound");

        if (topSound) {
          const wakeAudio = () => {
            try {
              topSound.volume = 0;
              topSound.play().catch(() => {});
              setTimeout(() => {
                try { topSound.pause(); topSound.currentTime = 0; } catch(e){}
              }, 40);
              topSound.volume = 1;
            } catch(e){}
            window.removeEventListener("click", wakeAudio);
            window.removeEventListener("touchstart", wakeAudio);
          };
          window.addEventListener("click", wakeAudio, { once: true });
          window.addEventListener("touchstart", wakeAudio, { once: true });
        }

        var simOnAir = false;
        var onAirRunning = false;
        var onAirStart = Date.now();
        var onAirFrozenSec = 0;

        var topActive = false;

        function updateBackground() {
          body.classList.remove("status-default", "status-onair", "status-top");
          if (topActive)     body.classList.add("status-top");
          else if (simOnAir) body.classList.add("status-onair");
          else               body.classList.add("status-default");
        }

        function setOnAirState(active) {
          simOnAir = active;
          if (active) {
            onAirStart = Date.now();
            onAirRunning = true;
            if (onairLabelEl) onairLabelEl.textContent = "ON AIR";
            if (ordresBtn) ordresBtn.classList.add("btn-active");
          } else {
            onAirRunning = false;
            if (onairLabelEl) onairLabelEl.textContent = "";
            if (ordresBtn) ordresBtn.classList.remove("btn-active");
          }
          updateBackground();
        }

        setOnAirState(false);

        /* Points de l’horloge */
        var DOT_COUNT = 60;
        var DOT_RADIUS = 1.9;
        var DOT_RING_RADIUS = 80;
        var dots = [];

        if (dotsLayer) {
          for (var d = 0; d < DOT_COUNT; d++) {
            var angle = (d / DOT_COUNT) * 2 * Math.PI - Math.PI/2;
            var x = 100 + DOT_RING_RADIUS * Math.cos(angle);
            var y = 100 + DOT_RING_RADIUS * Math.sin(angle);
            var c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            c.setAttribute("class","clock-dot");
            c.setAttribute("cx", x.toFixed(2));
            c.setAttribute("cy", y.toFixed(2));
            c.setAttribute("r", DOT_RADIUS);
            dotsLayer.appendChild(c);
            dots.push(c);
          }
        }

        /* NTP */
        var clockOffsetMs = 0;
        fetch("/api/ntp")
          .then(r => r.json())
          .then(ntp => {
            if (ntp && typeof ntp.offsetMs === "number") clockOffsetMs = ntp.offsetMs;
          })
          .catch(()=>{});

        /* Cycle NP local (provisoire) */
        var trackIntro = 10;
        var trackMain  = 150;
        var trackOutro = 8;
        var cycleTotal = trackIntro + trackMain + trackOutro;
        var cycleStart = Date.now();
        var npSyncLastSec = null;

        var lastSecond = null;

        function updateClock() {
          var now = new Date(Date.now() + clockOffsetMs);
          var sec = now.getSeconds();
          var mm = pad2(now.getMinutes());
          var hh = pad2(now.getHours());
          var ss = pad2(sec);

          if (clockTimeEl) clockTimeEl.textContent = hh + ":" + mm + ":" + ss;

          if (sec !== lastSecond && dots.length === DOT_COUNT) {
            if (sec === 0) dots.forEach(d => d.classList.remove("active"));
            dots[sec].classList.add("active");
            lastSecond = sec;
          }

          var chronoSec = onAirRunning ? (Date.now() - onAirStart)/1000 : onAirFrozenSec;
          if (headerOnAirChrono) headerOnAirChrono.textContent = formatMMSS(chronoSec);

          if (npSyncLastSec === null) npSyncLastSec = sec;
          else {
            if (npSyncLastSec === 59 && sec === 0) cycleStart = Date.now();
            npSyncLastSec = sec;
          }

          var elapsed = (Date.now() - cycleStart)/1000;
          var t = elapsed % cycleTotal;
          var display = "00:00";
          var ringFraction = 0;
          var rootStyle = getComputedStyle(document.documentElement);
          var ringColor = rootStyle.getPropertyValue("--np-green").trim() || "#23d56b";
          var npTextColor = ringColor;

          var tIntroEnd = trackIntro;
          var tMainEnd  = tIntroEnd + trackMain;

          if (t < tIntroEnd) {
            var remain = trackIntro - t;
            display = formatMMSS(remain);
            ringFraction = t / trackIntro;
            ringColor = rootStyle.getPropertyValue("--np-orange").trim() || "#ff9f0a";
            npTextColor = ringColor;
            if (npPhaseLabelEl) npPhaseLabelEl.textContent = "INTRO";
          }
          else if (t < tMainEnd) {
            var remain = trackMain - (t - tIntroEnd);
            display = formatMMSS(remain);
            ringFraction = (t - tIntroEnd) / trackMain;
            ringColor = rootStyle.getPropertyValue("--np-green").trim() || "#23d56b";
            npTextColor = ringColor;
            if (npPhaseLabelEl) npPhaseLabelEl.textContent = "";
          }
          else {
            var remain = trackOutro - (t - tMainEnd);
            display = formatMMSS(remain);
            ringFraction = (t - tMainEnd) / trackOutro;
            ringColor = rootStyle.getPropertyValue("--np-orange").trim() || "#ff9f0a";
            npTextColor = ringColor;
            if (npPhaseLabelEl) npPhaseLabelEl.textContent = "OUTRO";
          }

          if (npChronoMainEl) {
            npChronoMainEl.textContent = display;
            npChronoMainEl.style.color = npTextColor;
          }

          if (npRingProgress) {
            var R = 70;
            var C = 2*Math.PI*R;
            var offset = C * (1 - ringFraction);
            npRingProgress.style.strokeDasharray = C.toFixed(2);
            npRingProgress.style.strokeDashoffset = offset.toFixed(2);
            npRingProgress.style.stroke = ringColor;
          }
        }

        function loop(){ updateClock(); requestAnimationFrame(loop); }
        loop();

        /* WEBSOCKET + TOP global */
        var messages = [];
        var ws = null;

        function sendTopState(active){
          if (!ws || ws.readyState!==WebSocket.OPEN) return;
          try {
            ws.send(JSON.stringify({
              type:"top",
              studio: studio,
              active: !!active
            }));
          } catch(e){}
        }

        var topMin = 200;
        var topDownAt = 0;

        if (topBtn){
          function topStart(e){
            if (e && e.preventDefault) e.preventDefault();
            topDownAt = Date.now();
            topActive = true;
            topBtn.classList.add("btn-active");
            updateBackground();

            if (topSound){
              try { topSound.currentTime = 0; topSound.play().catch(()=>{}); } catch(e){}
            }

            sendTopState(true);
          }

          function topEnd(e){
            if (!topActive) return;
            if (e && e.preventDefault) e.preventDefault();
            var elapsed = Date.now() - topDownAt;
            var remain = topMin - elapsed;

            function finalize(){
              topActive = false;
              topBtn.classList.remove("btn-active");
              updateBackground();
              sendTopState(false);
            }

            if (remain <= 0) finalize();
            else setTimeout(finalize, remain);
          }

          topBtn.addEventListener("mousedown", topStart);
          topBtn.addEventListener("touchstart", topStart);

          window.addEventListener("mouseup", topEnd);
          window.addEventListener("mouseleave", topEnd);
          window.addEventListener("touchend", topEnd);
          window.addEventListener("touchcancel", topEnd);
        }

        if (ordresBtn) {
          ordresBtn.addEventListener("click", function(e){
            if (e && e.preventDefault) e.preventDefault();
            setOnAirState(!simOnAir);
          });
        }

        /* CHAT */
        var chatOverlay = byId("chat-overlay");
        var chatModal = byId("chat-modal");
        var chatClose = byId("chat-close");
        var chatBody = byId("chat-modal-body");
        var chatInput = byId("chat-input");
        var chatSend = byId("chat-send");
        var chatLastInline = byId("chat-last-inline");
        var chatLastInlineText = byId("chat-last-inline-text");

        function updateLastMessageUI(){
          if (!messages.length) return;
          var last = messages[messages.length-1];
          var txt = last.text || "";
          if (chatLastInlineText) chatLastInlineText.textContent = txt;
        }

        function renderMessages(){
          if (!chatBody) return;
          chatBody.innerHTML = "";
          messages.forEach(function(m){
            var div = document.createElement("div");
            div.className = "chat-message";
            var h = document.createElement("div");
            h.className = "chat-message-header";
            var spanUser = document.createElement("span");
            spanUser.textContent = m.user || "???";
            var spanTime = document.createElement("time");
            spanTime.textContent = m.ts ? m.ts.substring(11,16) : nowHHMM();
            h.appendChild(spanUser);
            h.appendChild(spanTime);
            var t = document.createElement("div");
            t.className = "chat-message-text";
            t.textContent = m.text || "";
            div.appendChild(h);
            div.appendChild(t);
            chatBody.appendChild(div);
          });
          chatBody.scrollTop = chatBody.scrollHeight;
          updateLastMessageUI();
        }

        function openChat(){
          if (!chatOverlay) return;
          chatOverlay.style.display = "flex";
        }
        function closeChat(){
          if (!chatOverlay) return;
          chatOverlay.style.display = "none";
        }

        if (chatLastInline) chatLastInline.addEventListener("click", openChat);
        if (chatClose) chatClose.addEventListener("click", closeChat);
        if (chatOverlay) {
          chatOverlay.addEventListener("click", function(e){
            if (e.target === chatOverlay) closeChat();
          });
        }

        function addMessage(entry){
          if (!entry) return;
          messages.push({
            user: entry.user || "???",
            text: entry.text || "",
            ts: entry.ts || new Date().toISOString()
          });
          renderMessages();
        }

        function initWS(){
          var proto = location.protocol==="https:"?"wss":"ws";
          ws = new WebSocket(proto + "://" + location.host + "/ws");

          ws.addEventListener("open", function(){
            try {
              ws.send(JSON.stringify({
                type:"hello",
                role:"chat",
                user: userName + (userRole?(" ("+userRole+" "+studio+")"):"")
              }));
            } catch(e){}
          });

          ws.addEventListener("message", function(e){
            var data;
            try { data = JSON.parse(e.data); } catch(_){ return; }

            if (data.type==="history" && Array.isArray(data.history)){
              messages = data.history.map(m => ({
                user: m.user,
                text: m.text,
                ts: m.ts
              }));
              renderMessages();
            }

            if (data.type==="chat" && data.message) addMessage(data.message);
            if (data.type==="nowPlaying" && data.nowPlaying) applyNowPlaying(data.nowPlaying);

            if (data.type==="top"){
              if (data.studio && data.studio !== studio) return;
              topActive = !!data.active;
              if (topBtn) {
                if (topActive) topBtn.classList.add("btn-active");
                else           topBtn.classList.remove("btn-active");
              }
              updateBackground();
            }
          });

          ws.addEventListener("close", ()=> setTimeout(initWS, 4000));
        }

        initWS();

        function sendMessage(){
          if (!chatInput) return;
          var t = (chatInput.value || "").trim();
          if (!t) return;
          if (ws && ws.readyState===WebSocket.OPEN){
            ws.send(JSON.stringify({ type:"chat", text:t }));
          } else {
            addMessage({ user:userName, text:t });
          }
          chatInput.value = "";
        }

        if (chatSend) {
          chatSend.addEventListener("click", function(e){
            if (e && e.preventDefault) e.preventDefault();
            sendMessage();
          });
        }

        if (chatInput) {
          chatInput.addEventListener("keydown", function(e){
            e = e || window.event;
            if (e.key === "Enter" || e.keyCode === 13){
              if (e.preventDefault) e.preventDefault();
              sendMessage();
            }
          });
        }
      });
    })();
  </script>
</body>
</html>
